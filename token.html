<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <title>ITDEV.win</title>
</head>
<body>
<center>
    <h1>ลงทะเบียนแจ้งเตือน</h1>
    <p>ใส่รหัสนักเรียน/นักศึกษา </p>
    <p>เพื่อรับแจ้งเตือนการเข้าเรียนทางไลน์</p>
    <div class="form-group mx-sm-3 mb-2">
        <label for="inputPassword2" class="sr-only">ใส่รหัสนักเรียน</label>
        <input type="text" class="form-control" id="stdid" placeholder="ใส่รหัสนักเรียน">
    </div></br></br>

    <!-- Loading Spinner -->
    <div class="spinner-border text-primary" role="status" id="loading" style="display: none;">
        <span class="sr-only">Loading...</span>
    </div>

    <div id="cin" class="visible">
        <button type="button" class="btn btn-success" onclick="letg()">เชื่อมต่อกับไลน์</button>
        <p id="tex1"></p>
    </div>
</center>

<script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
window.onload = function() {
    initializeLiff('2006281858-5WMnMNO1');
}

function initializeLiff(myLiffId) {
    liff.init({ liffId: myLiffId }, function() {
        liff.ready.then(() => {
            if (liff.isLoggedIn()) {
                liff.getProfile().then(profile => {
                    console.log(profile.userId);
                });
                console.log('login ok');
            } else {
                console.log('login notok');
                liff.login();
            }
        });
    });
}

function letg() {
    var x = document.getElementById("tex1");
    var x2 = document.getElementById("stdid").value;

    liff.getProfile().then(function(profile) {
        var uid = profile.userId;
        var uname = profile.displayName;

        x.innerHTML = "<br>StdId: " + x2 +
            "<br>userId: " + uid +
            "<br>displayName: " + uname;

        // แสดง SweetAlert2 เมื่อสำเร็จ
        Swal.fire({
            icon: 'success',
            title: 'เชื่อมต่อสำเร็จ',
            text: 'คุณได้รับการเชื่อมต่อกับไลน์แล้ว!',
            confirmButtonText: 'ตกลง'
        }).then(() => {
            // เริ่มกระบวนการส่งโค้ด
            sendTokenToServer(x2, uid, uname);
        });
    });
}

function sendTokenToServer(stdId, userId, userName) {
    const xurl = "https://script.google.com/macros/s/AKfycbwiY2wdEmft7NLbxUBpyi0B-l8lbYCl8gG1o5Qg_s3Vc4orwU3tsL5jo0b9ckm3zD3JZQ/exec";

    var data = {
        "state": stdId,
        "uid": userId,
        "uname": userName
    };

    var xmlhttp = new XMLHttpRequest();
    xmlhttp.open("POST", xurl, true);
    xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
    xmlhttp.send(JSON.stringify(data));

    xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var jsonResponse = JSON.parse(this.responseText);
            alert(jsonResponse.desc);
            liff.closeWindow();
        }
    };
}
</script>

<!-- Optional JavaScript -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
</body>
</html>
